# install packages
apt update && apt upgrade -y && apt install -y mysql-server tcpdump screen ntp ntpdate git-core dkms gcc flex bison libmysqlclient-dev make \
libssl-dev libcurl4-openssl-dev libxml2-dev libpcre3-dev bash-completion g++ autoconf rtpproxy libmnl-dev libsctp-dev ipsec-tools libradcli-dev \
libradcli4

#Clone Kamailio repository and checkout 5.3 version of repository
mkdir -p /usr/local/src/
cd /usr/local/src/
git clone https://github.com/herlesupreeth/kamailio
cd kamailio
git checkout -b 5.3 origin/5.3

#Generate build config files
cd /usr/local/src/kamailio
make cfg

#Enable MySQL module and all required IMS modules.

cat <<\EOF >/usr/local/src/kamailio/src/modules.lst
# this file is autogenerated by make modules-cfg

# the list of sub-directories with modules
modules_dirs:=modules

# the list of module groups to compile
cfg_group_include=

# the list of extra modules to compile
include_modules= cdp cdp_avp db_mysql dialplan ims_auth ims_charging ims_dialog ims_diameter_server ims_icscf ims_ipsec_pcscf ims_isc ims_ocs ims_qos ims_registrar_pcscf ims_registrar_scscf ims_usrloc_pcscf ims_usrloc_scscf outbound presence presence_conference presence_dialoginfo presence_mwi presence_profile presence_reginfo presence_xml pua pua_bla pua_dialoginfo pua_reginfo pua_rpc pua_usrloc pua_xmpp sctp tls utils xcap_client xcap_server xmlops xmlrpc

# the list of static modules
static_modules=

# the list of modules to skip from compile list
skip_modules=

# the list of modules to exclude from compile list
exclude_modules= acc_json acc_radius app_java app_lua app_lua_sr app_mono app_perl app_python app_python3 app_ruby auth_ephemeral auth_identity auth_radius cnxcc cplc crypto db2_ldap db_berkeley db_cassandra db_mongodb db_oracle db_perlvdb db_postgres db_redis db_sqlite db_unixodbc dnssec erlang evapi geoip geoip2 gzcompress h350 http_async_client http_client jansson janssonrpcc json jsonrpcc kafka kazoo lcr ldap log_systemd lost memcached misc_radius ndb_cassandra ndb_mongodb ndb_redis nsq osp peering phonenum pua_json rabbitmq regex rls rtp_media_server snmpstats systemdops topos_redis uuid websocket xhttp_pi xmpp $(skip_modules)

modules_all= $(filter-out modules/CVS,$(wildcard modules/*))
modules_noinc= $(filter-out $(addprefix modules/, $(exclude_modules) $(static_modules)), $(modules_all))
modules= $(filter-out $(modules_noinc), $(addprefix modules/, $(include_modules) )) $(modules_noinc)
modules_configured:=1
EOF

#Compile and install Kamailio
cd /usr/local/src/kamailio
export RADCLI=1
make Q=0 all | tee make_all.txt
make install | tee make_install.txt
ldconfig

if [[ -z $(echo $PATH | grep '/usr/local/sbin') ]];then
echo "PATH=$PATH:/usr/local/sbin
export PATH" >> /root/.bash_profile
fi

#Populate MySQL database using kamctlrc command

kamctlrc_conf='SIP_DOMAIN=ims.mnc001.mcc001.3gppnetwork.org\nDBENGINE=MYSQL\n'
sed -i "1s/^/$kamctlrc_conf/" /usr/local/etc/kamailio/kamctlrc

printf " \ny" | kamdbctl create

#to check DB --> to improve script 
# mysql -e 'use kamailio; show tables;' --> if there is not result = problem
# mysql -e 'use kamailio;' --> if there is results = problem

#Edit rtpproxy 

#interface=eth1
#private_ip=$(ifconfig $interface | grep 'inet' | head -n1 | tail -n1 | awk {'print $2'})

echo "# Defaults for rtpproxy

# The control socket.
#CONTROL_SOCK=\"unix:/var/run/rtpproxy/rtpproxy.sock\"
# To listen on an UDP socket, uncomment this line:
#CONTROL_SOCK=udp:127.0.0.1:22222
CONTROL_SOCK=udp:127.0.0.1:7722

# Additional options that are passed to the daemon.
EXTRA_OPTS=\"-l $private_ip -d DBUG:LOG_LOCAL0\"" > /etc/default/rtpproxy

systemctl restart rtpproxy


#Edit configuration file to fit your requirements for the VoIP platform

enable_usage_mysql1='#!define WITH_MYSQL\n#!define WITH_AUTH\n#!define WITH_USRLOCDB\n#!define WITH_NAT\n'
sed -i "1s/^/$enable_usage_mysql1/" /usr/local/etc/kamailio/kamailio.cfg

sed -i '/# auto_aliases=no/s/^# //g' /usr/local/etc/kamailio/kamailio.cfg

sed -i 's/# alias="sip.mydomain.com"/alias="ims.mnc001.mcc001.3gppnetwork.org"/' /usr/local/etc/kamailio/kamailio.cfg

enable_usage_mysql2='listen=udp:10.4.128.21:5060 advertise 172.24.15.30:5060\nlisten=tcp:10.4.128.21:5060 advertise 172.24.15.30:5060'

sed -i "s/# listen=udp:10.0.0.10:5060/$enable_usage_mysql2/" /usr/local/etc/kamailio/kamailio.cfg

#The init.d script

cp /usr/local/src/kamailio/pkg/kamailio/deb/bionic/kamailio.init /etc/init.d/kamailio
chmod 755 /etc/init.d/kamailio

sed -i 's/PATH=.*/PATH=\/sbin:\/bin:\/usr\/sbin:\/usr\/bin:\/usr\/local\/sbin/' /etc/init.d/kamailio

sed -i 's/DAEMON=.*/DAEMON=\/usr\/local\/sbin\/kamailio/' /etc/init.d/kamailio

sed -i 's/CFGFILE=.*/CFGFILE=\/usr\/local\/etc\/kamailio\/kamailio.cfg/' /etc/init.d/kamailio

cp /usr/local/src/kamailio/pkg/kamailio/deb/bionic/kamailio.default /etc/default/kamailio

sed -i '/#RUN_KAMAILIO=yes/s/^#//g' /etc/default/kamailio

systemctl daemon-reload
mkdir -p /var/run/kamailio
cd && adduser --quiet --system --group --disabled-password \
        --shell /bin/false --gecos "Kamailio" \
        --home /var/run/kamailio kamailio

chown kamailio:kamailio /var/run/kamailio

systemctl start kamailio.service

#verifie par ps axw	| egrep kamailio --> si il y'a rien fail 

