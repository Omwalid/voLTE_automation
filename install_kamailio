#! /bin/bash

# install packages
apt update && apt upgrade -y && apt install -y mysql-server tcpdump screen ntp ntpdate git-core dkms gcc flex bison libmysqlclient-dev make \
libssl-dev libcurl4-openssl-dev libxml2-dev libpcre3-dev bash-completion g++ autoconf rtpproxy libmnl-dev libsctp-dev ipsec-tools libradcli-dev \
libradcli4

#Clone Kamailio repository and checkout 5.3 version of repository
mkdir -p /usr/local/src/
cd /usr/local/src/
git clone https://github.com/herlesupreeth/kamailio
cd kamailio
git checkout -b 5.3 origin/5.3

#Generate build config files
cd /usr/local/src/kamailio
make cfg

#Enable MySQL module and all required IMS modules.

cat <<\EOF >/usr/local/src/kamailio/src/modules.lst
# this file is autogenerated by make modules-cfg

# the list of sub-directories with modules
modules_dirs:=modules

# the list of module groups to compile
cfg_group_include=

# the list of extra modules to compile
include_modules= cdp cdp_avp db_mysql dialplan ims_auth ims_charging ims_dialog ims_diameter_server ims_icscf ims_ipsec_pcscf ims_isc ims_ocs ims_qos ims_registrar_pcscf ims_registrar_scscf ims_usrloc_pcscf ims_usrloc_scscf outbound presence presence_conference presence_dialoginfo presence_mwi presence_profile presence_reginfo presence_xml pua pua_bla pua_dialoginfo pua_reginfo pua_rpc pua_usrloc pua_xmpp sctp tls utils xcap_client xcap_server xmlops xmlrpc

# the list of static modules
static_modules=

# the list of modules to skip from compile list
skip_modules=

# the list of modules to exclude from compile list
exclude_modules= acc_json acc_radius app_java app_lua app_lua_sr app_mono app_perl app_python app_python3 app_ruby auth_ephemeral auth_identity auth_radius cnxcc cplc crypto db2_ldap db_berkeley db_cassandra db_mongodb db_oracle db_perlvdb db_postgres db_redis db_sqlite db_unixodbc dnssec erlang evapi geoip geoip2 gzcompress h350 http_async_client http_client jansson janssonrpcc json jsonrpcc kafka kazoo lcr ldap log_systemd lost memcached misc_radius ndb_cassandra ndb_mongodb ndb_redis nsq osp peering phonenum pua_json rabbitmq regex rls rtp_media_server snmpstats systemdops topos_redis uuid websocket xhttp_pi xmpp $(skip_modules)

modules_all= $(filter-out modules/CVS,$(wildcard modules/*))
modules_noinc= $(filter-out $(addprefix modules/, $(exclude_modules) $(static_modules)), $(modules_all))
modules= $(filter-out $(modules_noinc), $(addprefix modules/, $(include_modules) )) $(modules_noinc)
modules_configured:=1
EOF

#Compile and install Kamailio
cd /usr/local/src/kamailio
export RADCLI=1
make Q=0 all | tee make_all.txt
make install | tee make_install.txt
ldconfig

if [[ -z $(echo $PATH | grep '/usr/local/sbin') ]];then
echo "PATH=$PATH:/usr/local/sbin
export PATH" >> /root/.bash_profile
fi

#Populate MySQL database using kamctlrc command

kamctlrc_conf='SIP_DOMAIN=ims.mnc001.mcc001.3gppnetwork.org\nDBENGINE=MYSQL\n'
sed -i "1s/^/$kamctlrc_conf/" /usr/local/etc/kamailio/kamctlrc

printf " \ny" | kamdbctl create

#to check DB --> to improve script 
# mysql -e 'use kamailio; show tables;' --> if there is not result = problem
# mysql -e 'use kamailio;' --> if there is results = problem

#Edit rtpproxy 

interface=ens4
private_ip=$(ifconfig $interface | grep 'inet' | head -n1 | tail -n1 | awk {'print $2'})

echo "# Defaults for rtpproxy

# The control socket.
#CONTROL_SOCK=\"unix:/var/run/rtpproxy/rtpproxy.sock\"
# To listen on an UDP socket, uncomment this line:
#CONTROL_SOCK=udp:127.0.0.1:22222
CONTROL_SOCK=udp:127.0.0.1:7722

# Additional options that are passed to the daemon.
EXTRA_OPTS=\"-l $private_ip -d DBUG:LOG_LOCAL0\"" > /etc/default/rtpproxy

systemctl restart rtpproxy


#Edit configuration file to fit your requirements for the VoIP platform

enable_usage_mysql1='#!define WITH_MYSQL\n#!define WITH_AUTH\n#!define WITH_USRLOCDB\n#!define WITH_NAT\n'
sed -i "1s/^/$enable_usage_mysql1/" /usr/local/etc/kamailio/kamailio.cfg

sed -i '/# auto_aliases=no/s/^# //g' /usr/local/etc/kamailio/kamailio.cfg

sed -i 's/# alias="sip.mydomain.com"/alias="ims.mnc001.mcc001.3gppnetwork.org"/' /usr/local/etc/kamailio/kamailio.cfg

enable_usage_mysql2=$(echo "listen=udp:$private_ip:5060 advertise $private_ip:5060\nlisten=tcp:$private_ip:5060 advertise $private_ip:5060")

sed -i "s/# listen=udp:10.0.0.10:5060/$enable_usage_mysql2/" /usr/local/etc/kamailio/kamailio.cfg

#The init.d script

cp /usr/local/src/kamailio/pkg/kamailio/deb/bionic/kamailio.init /etc/init.d/kamailio
chmod 755 /etc/init.d/kamailio

sed -i 's/PATH=.*/PATH=\/sbin:\/bin:\/usr\/sbin:\/usr\/bin:\/usr\/local\/sbin/' /etc/init.d/kamailio

sed -i 's/DAEMON=.*/DAEMON=\/usr\/local\/sbin\/kamailio/' /etc/init.d/kamailio

sed -i 's/CFGFILE=.*/CFGFILE=\/usr\/local\/etc\/kamailio\/kamailio.cfg/' /etc/init.d/kamailio

cp /usr/local/src/kamailio/pkg/kamailio/deb/bionic/kamailio.default /etc/default/kamailio

sed -i '/#RUN_KAMAILIO=yes/s/^#//g' /etc/default/kamailio

systemctl daemon-reload
mkdir -p /var/run/kamailio
cd && adduser --quiet --system --group --disabled-password \
        --shell /bin/false --gecos "Kamailio" \
        --home /var/run/kamailio kamailio

chown kamailio:kamailio /var/run/kamailio

systemctl start kamailio.service

#verifie par ps axw	| egrep kamailio --> si il y'a rien fail 


#Create new mysql database for pcscf, scscf and icscf,
#populate databases and grant permissions to respective users identified by a password

mysql -e 'CREATE DATABASE  `pcscf`; CREATE DATABASE  `scscf`; CREATE DATABASE  `icscf`;'

cd /usr/local/src/kamailio/utils/kamctl/mysql
mysql -u root pcscf < standard-create.sql
mysql -u root pcscf < presence-create.sql
mysql -u root pcscf < ims_usrloc_pcscf-create.sql
mysql -u root pcscf < ims_dialog-create.sql

mysql -u root scscf < standard-create.sql
mysql -u root scscf < presence-create.sql
mysql -u root scscf < ims_usrloc_scscf-create.sql
mysql -u root scscf < ims_dialog-create.sql
mysql -u root scscf < ims_charging-create.sql

cd /usr/local/src/kamailio/misc/examples/ims/icscf
mysql -u root icscf < icscf.sql

#we can verify also 

mysql -e "grant delete,insert,select,update on pcscf.* to pcscf@localhost identified by 'heslo'; grant delete,insert,select,update on scscf.* to scscf@localhost identified by 'heslo'; grant delete,insert,select,update on icscf.* to icscf@localhost identified by 'heslo'; grant delete,insert,select,update on icscf.* to provisioning@localhost identified by 'provi'; GRANT ALL PRIVILEGES ON pcscf.* TO 'pcscf'@'%' identified by 'heslo'; GRANT ALL PRIVILEGES ON scscf.* TO 'scscf'@'%' identified by 'heslo'; GRANT ALL PRIVILEGES ON icscf.* TO 'icscf'@'%' identified by 'heslo'; GRANT ALL PRIVILEGES ON icscf.* TO 'provisioning'@'%' identified by 'provi'; FLUSH PRIVILEGES;"

mysql -e "use icscf; INSERT INTO \`nds_trusted_domains\` VALUES (1,'ims.mnc001.mcc001.3gppnetwork.org'); INSERT INTO \`s_cscf\` VALUES (1,'First and only S-CSCF','sip:scscf.ims.mnc001.mcc001.3gppnetwork.org:6060'); INSERT INTO \`s_cscf_capabilities\` VALUES (1,1,0),(2,1,1);"

#Copy pcscf, icscf and scscf configuration files to /etc folder and edit accordingly

cd ~ && git clone https://github.com/herlesupreeth/Kamailio_IMS_Config
cd Kamailio_IMS_Config
git checkout 7a0bf097a065c101a6d14929ca96e67dadb51a82
cp -r kamailio_icscf /etc
cp -r kamailio_pcscf /etc
cp -r kamailio_scscf /etc

#Install RTPEngine

export DEB_BUILD_PROFILES="pkg.ngcp-rtpengine.nobcg729"
apt install dpkg-dev
git clone https://github.com/sipwise/rtpengine
cd rtpengine && git checkout mr7.4.1

apt install -y debhelper default-libmysqlclient-dev gperf iptables-dev libavcodec-dev libavfilter-dev libavformat-dev libavutil-dev libbencode-perl libcrypt-openssl-rsa-perl libcrypt-rijndael-perl libdigest-crc-perl libdigest-hmac-perl libevent-dev libhiredis-dev libio-multiplex-perl libio-socket-inet6-perl libiptc-dev libjson-glib-dev libnet-interface-perl libpcap0.8-dev libsocket6-perl libspandsp-dev libswresample-dev libsystemd-dev libxmlrpc-core-c3-dev markdown dkms module-assistant keyutils libnfsidmap2 libtirpc1 nfs-common rpcbind
# check with dpkg-checkbuilddeps

dpkg-buildpackage -uc -us
cd ..
dpkg -i *.deb
cp /etc/rtpengine/rtpengine.sample.conf /etc/rtpengine/rtpengine.conf

sed -i "/\[rtpengine\]/ a interface = $private_ip"  /etc/rtpengine/rtpengine.conf

# verify modparam("rtpengine", "rtpengine_sock", "1 == udp:localhost:2223") in kamailio_pcscf.cfg

sed -i 's/RUN_RTPENGINE=.*/RUN_RTPENGINE=yes/' /etc/default/ngcp-rtpengine-daemon
sed -i 's/RUN_RTPENGINE_RECORDING=.*/RUN_RTPENGINE_RECORDING=yes/' /etc/default/ngcp-rtpengine-recording-daemon

cp /etc/rtpengine/rtpengine-recording.sample.conf /etc/rtpengine/rtpengine-recording.conf
mkdir /var/spool/rtpengine
systemctl restart ngcp-rtpengine-daemon.service ngcp-rtpengine-recording-daemon.service ngcp-rtpengine-recording-nfs-mount.service
systemctl enable ngcp-rtpengine-daemon.service ngcp-rtpengine-recording-daemon.service ngcp-rtpengine-recording-nfs-mount.service

#check with systemctl status 

systemctl stop rtpproxy
systemctl disable rtpproxy
systemctl mask rtpproxy

#Running I-CSCF, P-CSCF and S-CSCF as separate process

systemctl stop kamailio
systemctl disable kamailio
systemctl mask kamailio

#need to change cofig /etc/kamailio_xcscf/xcscf.cfg .xml

mkdir -p /var/run/kamailio_pcscf
# kamailio -f /etc/kamailio_pcscf/kamailio_pcscf.cfg -P /kamailio_pcscf.pid -DD -E -e

mkdir -p /var/run/kamailio_scscf
# kamailio -f /etc/kamailio_scscf/kamailio_scscf.cfg -P /kamailio_scscf.pid -DD -E -e

mkdir -p /var/run/kamailio_icscf
# kamailio -f /etc/kamailio_icscf/kamailio_icscf.cfg -P /kamailio_icscf.pid -DD -E -e

nodes=('icscf' 'pcscf' 'scscf')

for node in "${nodes[@]}"
do

  cp /etc/init.d/kamailio /etc/init.d/kamailio_$node

  sed -i 's/PATH=.*/PATH=\/sbin:\/bin:\/usr\/sbin:\/usr\/bin:\/usr\/local\/sbin/' /etc/init.d/kamailio_$node
  sed -i "s/NAME=.*/NAME=\"kamailio_${node}\"/" /etc/init.d/kamailio_$node
  sed -i "s/CFGFILE=.*/CFGFILE=\/etc\/\$NAME\/kamailio_${node}\.cfg/" /etc/init.d/kamailio_$node

  cd /etc/default/
  cp kamailio kamailio_$node

  sed -i "/RUN_KAMAILIO=yes/ a CFGFILE=\/etc\/kamailio_${node}\/kamailio_${node}\.cfg"  /etc/default/kamailio_$node

done

systemctl daemon-reload
systemctl start  kamailio_scscf  kamailio_pcscf kamailio_icscf

